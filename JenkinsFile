pipeline {
enviornment {
  registry="dockerhub-account/docker-repositoryname"
  registryCredential = 'credentialsid' //Created in Jenkins with ID
  }
agent {dockerfile true }
}
stages
{
stage('Build Image')
{
steps{
def testImage = docker.build("test-image", "./dockerfiles/test")+${env.BUILD_NUMBER}
}
}
stage('Deploying Image to Docker Registry')
{
steps{
script{
docker.withRegistry(registry,registryCredential){
testImage.push()
}
}
}
stage('Deploy Image to K8 cluster')
{
steps{
script{
kubectl apply -f jenkins-deployment.yaml
kubectl apply -f jenkins-service.yaml
}
}
}
stage('Upload Artifact to s3 Bucket')
{
steps{
dir('/Path to jenkins job artifact or path to Project workspace')
{

withAWS(region:'S3 Region to where artifacts need to be uploaded',credentials:'AWS Credentials created where EC2 instance for Jenkins server resides')
{
Workding directory is from where artifacts need to be uploaded:- It should be path to particual Jenkins build to get artifacts from)
s3Upload(bucket:"yourBucketName", workingDir:'dist', includePathPattern:'**/*');
}
}
};
